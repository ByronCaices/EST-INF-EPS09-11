---
title: "EP10-respuesta-equipo-2"
output: html_document
date: "2024-12-11"
---

```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cran.rstudio.com/"))

if (!requireNamespace('tidyverse', quietly = TRUE)){
  install.packages('tidyverse')
}
library(tidyverse)
if (!requireNamespace('ggpubr', quietly = TRUE)){
  install.packages('ggpubr')
}
library(car)
if (!requireNamespace('car', quietly = TRUE)){
  install.packages('car')
}
library(ggpubr)
if (!requireNamespace('ez', quietly = TRUE)){
  install.packages('ez')
}
library(ez)
if (!requireNamespace('RVAideMemoire', quietly = TRUE)){
  install.packages('RVAideMemoire')
}
library(RVAideMemoire)
if (!requireNamespace('rcompanion', quietly = TRUE)){
  install.packages('rcompanion')
}
library(rcompanion)
if (!requireNamespace('dplyr', quietly = TRUE)){
  install.packages('dplyr')
}
library(dplyr)
if (!requireNamespace('WRS2', quietly = TRUE)){
  install.packages('WRS2')
}
library(WRS2)
```

#### CONTEXTO
#### Usando los datos de medidas anatómicas recolectados por Heinz et al. (2003) que ya conocimos en el ejercicio práctico anterior:

```{r datos}
datosGenerales <- read.csv2("EP09 Datos.csv")
head(datosGenerales)
```

#### se nos pide realizar lo siguiente:

#### 1. El equipo crea la variable IMC (índice de masa corporal) como el peso de una persona (en kilogramos) dividida por el cuadrado de su estatura (en metros).

```{r IMC}
datosGenerales[["IMC"]] = datosGenerales[["Weight"]] / ((datosGenerales[["Height"]]/100)^2)
```

#### 2. Si bien esta variable se usa para clasificar a las personas en varias clases de estado nutricional (bajo peso, normal, sobrepeso, obesidad, obesidad mórbida), para efectos de este ejercicio, usaremos dos clases: sobrepeso (IMC ≥ 23,2) y no sobrepeso (IMC < 23,2).

#### 3. El equipo crea la variable dicotómica EN (estado nutricional) de acuerdo al valor de IMC de cada persona.
```{r EN}
datosSobrepeso = datosGenerales %>% filter(IMC < 23.2)
datosPesoNormal = datosGenerales %>% filter(IMC >= 23.2)
datosSobrepeso[["EN"]] = 1
datosPesoNormal[["EN"]] = 0
```

#### Ahora podemos construir un modelo de regresión logística para predecir la variable EN, de acuerdo con las siguientes instrucciones:

### 1- Definir la semilla a utilizar, que corresponde a los últimos cuatro dígitos del RUN (sin considerar el dígito verificador) del integrante de mayor edad del equipo.

```{r seed}
set.seed(4545)  # semilla impar, tomamos muestra de 150 hombres
```

### 2- Seleccionar una muestra de 150 mujeres (si la semilla es un número par) o 150 hombres (si la semilla es impar), asegurando que la mitad tenga estado nutricional “sobrepeso” y la otra mitad “no sobrepeso” en cada caso. Dividir esta muestra en dos conjuntos: los datos de 100 personas (50 con EN “sobrepeso”) para utilizar en la construcción de los modelos y 50 personas (25 con EN “sobrepeso”) para poder evaluarlos.

```{r conjuntos}
datosSobrepeso = datosSobrepeso %>% filter(Gender == 1) %>% sample_n(75)
datosPesoNormal = datosPesoNormal %>% filter(Gender == 1) %>% sample_n(75)

idatosSobre = sample.int(50)
idatosNormal = sample.int(50)

datosEntrenamiento = rbind(datosSobrepeso[idatosSobre,], datosPesoNormal[idatosNormal,])
datosPrueba = rbind(datosSobrepeso[-idatosSobre,], datosPesoNormal[-idatosNormal,])
```

### 3- Recordar las ocho posibles variables predictoras seleccionadas de forma aleatoria en el ejercicio anterior.
Las variables aleatorias obtenidas del ejercicio anterior fueron las siguientes:

* Knee.Girth
* Weight
* Chest.diameter
* Wrist.Minimum.Girth
* Thigh.Girth
* Height
* Calf.Maximum.Girth
* Gender

```{r predictores}
predictores = c("Knee.Girth", "Weight", "Chest.diameter", "Wrist.Minimum.Girth", "Thigh.Girth", "Height", "Calf.Maximum.Girth")
# Gender no aplica
```

### 4- Seleccionar, de las otras variables, una que el equipo considere que podría ser útil para predecir la clase EN, justificando bien esta selección (idealmente con literatura).

Con respecto a una variable no listada que podría ser útil para predecir la clase EN, proponemos la variable "Waist.Girth" que corresponde al grosor de la cintura, y relacionamos razonablemente a la circunferencia de la cintura, sobre la que se dice lo siguiente en un artículo de la Universidad Central de Venezuela, Escuela de Nutrición y Dietética; "su comportamiento (de la Circunferencia de Cintura) es sistemático y consistente, se correlaciona con el IMC y con el Peso; la regresión logística revela su alta sensibilidad y especificidad, se recomienda la medición de la CC para evaluar sobrepeso y obesidad."

### 5- Usando el entorno R, construir un modelo de regresión logística con el predictor seleccionado en el paso anterior y utilizando la muestra obtenida.

```{r modelo simple}
modelo <- glm(EN ~ Waist.Girth, data = datosEntrenamiento, family = binomial(link = "logit"))
summary(modelo)
```

### 6- Usando estas herramientas para la exploración de modelos del entorno R, buscar entre dos y cinco predictores de entre las variables seleccionadas al azar, recordadas en el punto 3, para agregar al modelo obtenido en el paso 5.

Para esto usaremos regresion paso a paso hacia adelante
```{r modelo multiple}
# Datos con solo predictores:
datosPredictores <- datosEntrenamiento[, c("EN", predictores)]

modeloNulo <- glm(EN ~ 1, data = datosPredictores, family = binomial(link = "logit"))
modeloMaximo <- glm(EN ~ ., data = datosPredictores, family = binomial(link = "logit"))

# Revisar un paso hacia adelante
cat("\nPaso 1:\n----------------\n")
print(add1(modeloNulo, scope = modeloMaximo))
```

El valor más apto de agregar parece ser "Thigh.Girth", se actualiza y se reviza el modelo
```{r}
modelo1 <- update(modeloNulo, . ~ . + Thigh.Girth)
print(summary(modelo1))
```
Notas del modelo:

+ p-value de Thigh.Girth: 8.5e-07 (significativo)

AIC: 79.212

Se continua al siguiente paso
```{r}
cat("\nPaso 2:\n----------------\n")
print(add1(modelo1, scope = modeloMaximo))
```

El siguiente valor más apto de agregar es "Wrist.Minimum.Girth",  se actualiza y se reviza el modelo
```{r}
modelo2 <- update(modelo1, . ~ . + Wrist.Minimum.Girth)
print(summary(modelo2))
```
Notas del modelo:

+ p-value de Thigh.Girth: 4.15e-06 (significativo)
+ p-value de Wrist.Minimum.Girth: 0.0194 (significativo)

AIC: 75.176 (una disminución de 4.036 respecto al modelo sin Wrist.Minimum.Girth)

Se continua al siguiente paso
```{r}
cat("\nPaso 3:\n----------------\n")
print(add1(modelo2, scope = modeloMaximo))
```

El siguiente valor más apto de agregar es "Height",  se actualiza y se reviza el modelo
```{r}
modelo3 <- update(modelo2, . ~ . + Height)
print(summary(modelo3))
```
Notas del modelo:

+ p-value de Thigh.Girth: 3.22e-06 (significativo)
+ p-value de Wrist.Minimum.Girth: 0.003696 (significativo)
+ p-value de Height: 0.007628 (significativo)

AIC: 67.606 (una disminución de 7.57 respecto al modelo sin Height)

Se continua al siguiente paso
```{r}
cat("\nPaso 4:\n----------------\n")
print(add1(modelo3, scope = modeloMaximo))
```
Notas del modelo:

Se reporta desviación nula en caso de incluir la variable Weight, por lo que no la usaremos.

Solo Chest.diameter ofrece una disminución en AIC, pero una disminución de tan solo 0.178.

Se concluye que el modelo con las variables Thigh.Girth, Wrist.Minimum.Girth y Height es el más adecuado.

### 7- Evaluar la confiabilidad de los modelos (i.e. que tengan un buen nivel de ajuste y son generalizables) y “arreglarlos” en caso de que tengan algún problema.

```{r evaluacion}

```

### 8- Usando código estándar, evaluar el poder predictivo de los modelos con los datos de las 50 personas que no se incluyeron en su construcción en términos de sensibilidad y especificidad.

```{r pruebas}

```

### Referencias:

*  Bauce G. La circunferencia de cintura: un indicador de sobrepeso y obesidad.Rev. Digit Postgrado.2023;12(2):e365.doi:10.37910/RDP.2023.12.2.e365
